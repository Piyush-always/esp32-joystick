<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 MQTT Controller</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .broker-settings {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        .broker-settings input, .broker-settings select {
            padding: 8px;
            margin: 5px;
        }
        
        .broker-settings button {
            padding: 8px 15px;
        }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            max-width: 300px;
            margin: 0 auto;
        }
        
        button {
            padding: 15px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:active {
            background-color: #3e8e41;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #stop {
            background-color: #f44336;
            grid-column: 2;
        }
        
        #stop:hover {
            background-color: #d32f2f;
        }
        
        #connection-status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .connected {
            background-color: #dff0d8;
            color: #3c763d;
        }
        
        .disconnected {
            background-color: #f2dede;
            color: #a94442;
        }
        
        #status-messages {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1>ESP32 MQTT Controller</h1>
    
    <div class="broker-settings">
        <h3>MQTT Broker Settings</h3>
        <div>
            <select id="broker-select">
                <option value="broker.emqx.io">EMQX (broker.emqx.io)</option>
                <option value="broker.hivemq.com">HiveMQ (broker.hivemq.com)</option>
                <option value="test.mosquitto.org">Mosquitto (test.mosquitto.org)</option>
                <option value="custom">Custom...</option>
            </select>
            <input type="text" id="custom-broker" placeholder="Custom broker address" style="display:none;">
            <input type="number" id="broker-port" value="8000" min="1" max="65535">
            <button id="connect-button">Connect</button>
            <button id="disconnect-button" disabled>Disconnect</button>
        </div>
    </div>
    
    <div class="control-panel">
        <div></div>
        <button id="forward" disabled>Forward</button>
        <div></div>
        <button id="left" disabled>Left</button>
        <button id="stop" disabled>Stop</button>
        <button id="right" disabled>Right</button>
        <div></div>
        <button id="backward" disabled>Backward</button>
        <div></div>
    </div>
    
    <div id="connection-status" class="disconnected">Disconnected</div>
    
    <h2>Status Messages</h2>
    <div id="status-messages"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script>
        // Default MQTT settings
        let brokerHost = "broker.emqx.io";
        let brokerPort = 8000; // WebSocket port
        const commandTopic = "esp32controller/commands";
        const statusTopic = "esp32controller/status";
        
        // Generate a random client ID
        const clientId = "WebClient-" + Math.random().toString(16).substr(2, 8);
        
        // Create MQTT client
        let client = null;

        // DOM elements
        const brokerSelect = document.getElementById("broker-select");
        const customBroker = document.getElementById("custom-broker");
        const brokerPortInput = document.getElementById("broker-port");
        const connectButton = document.getElementById("connect-button");
        const disconnectButton = document.getElementById("disconnect-button");
        
        // Event listeners for broker settings
        brokerSelect.addEventListener("change", function() {
            if (this.value === "custom") {
                customBroker.style.display = "inline";
                brokerHost = customBroker.value || "localhost";
            } else {
                customBroker.style.display = "none";
                brokerHost = this.value;
            }
        });
        
        customBroker.addEventListener("input", function() {
            if (this.value) {
                brokerHost = this.value;
            }
        });
        
        brokerPortInput.addEventListener("change", function() {
            brokerPort = parseInt(this.value);
        });
        
        connectButton.addEventListener("click", initializeAndConnect);
        disconnectButton.addEventListener("click", disconnect);
        
        function initializeAndConnect() {
            updateConnectionStatus("Initializing connection...");
            
            if (client && client.isConnected()) {
                client.disconnect();
            }
            
            // Get the latest broker settings
            if (brokerSelect.value === "custom") {
                brokerHost = customBroker.value || "localhost";
            } else {
                brokerHost = brokerSelect.value;
            }
            
            brokerPort = parseInt(brokerPortInput.value);
            
            // Create a new MQTT client
            client = new Paho.MQTT.Client(brokerHost, brokerPort, clientId);
            
            // Set callback handlers
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
            
            // Connect to the broker
            connect();
        }
        
        function connect() {
            const options = {
                timeout: 3,
                onSuccess: onConnect,
                onFailure: onFailure,
                useSSL: window.location.protocol === "https:"
            };
            
            updateConnectionStatus("Connecting to " + brokerHost + ":" + brokerPort + "...");
            logMessage("Connecting to " + brokerHost + ":" + brokerPort);
            
            try {
                client.connect(options);
            } catch (error) {
                updateConnectionStatus("Connection error: " + error.message);
                logMessage("Connection error: " + error.message);
            }
        }
        
        function disconnect() {
            if (client && client.isConnected()) {
                client.disconnect();
                updateConnectionStatus("Disconnected", false);
                logMessage("Disconnected from MQTT broker");
                enableControls(false);
                connectButton.disabled = false;
                disconnectButton.disabled = true;
            }
        }
        
        function onConnect() {
            updateConnectionStatus("Connected to " + brokerHost, true);
            logMessage("Connected to MQTT broker: " + brokerHost);
            
            // Subscribe to status messages
            client.subscribe(statusTopic);
            logMessage("Subscribed to: " + statusTopic);
            
            // Enable buttons
            enableControls(true);
            connectButton.disabled = true;
            disconnectButton.disabled = false;
        }
        
        function onFailure(error) {
            updateConnectionStatus("Connection failed: " + error.errorMessage);
            logMessage("Connection failed: " + error.errorMessage);
            
            // Enable connect button
            connectButton.disabled = false;
            disconnectButton.disabled = true;
        }
        
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                updateConnectionStatus("Connection lost: " + responseObject.errorMessage);
                logMessage("Connection lost: " + responseObject.errorMessage);
                enableControls(false);
                connectButton.disabled = false;
                disconnectButton.disabled = true;
            }
        }
        
        function onMessageArrived(message) {
            const payload = message.payloadString;
            logMessage("Status: " + payload);
        }
        
        function sendCommand(command) {
            if (!client || !client.isConnected()) {
                logMessage("Not connected. Cannot send command.");
                return;
            }
            
            const message = new Paho.MQTT.Message(command);
            message.destinationName = commandTopic;
            
            try {
                client.send(message);
                logMessage("Sent command: " + command);
            } catch (error) {
                logMessage("Error sending command: " + error.message);
            }
        }
        
        function updateConnectionStatus(status, isConnected = false) {
            const statusElement = document.getElementById("connection-status");
            statusElement.textContent = status;
            
            if (isConnected) {
                statusElement.className = "connected";
            } else {
                statusElement.className = "disconnected";
            }
        }
        
        function logMessage(message) {
            const statusElement = document.getElementById("status-messages");
            const timestamp = new Date().toLocaleTimeString();
            statusElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            statusElement.scrollTop = statusElement.scrollHeight;
        }
        
        function enableControls(enable) {
            const buttons = document.querySelectorAll(".control-panel button");
            buttons.forEach(button => {
                button.disabled = !enable;
            });
        }
        
        // Set up button event listeners
        document.getElementById("forward").addEventListener("click", () => sendCommand("forward"));
        document.getElementById("backward").addEventListener("click", () => sendCommand("backward"));
        document.getElementById("left").addEventListener("click", () => sendCommand("left"));
        document.getElementById("right").addEventListener("click", () => sendCommand("right"));
        document.getElementById("stop").addEventListener("click", () => sendCommand("stop"));
        
        // Initially log the setup
        logMessage("Controller interface loaded");
        logMessage("Ready to connect to MQTT broker");
    </script>
</body>
</html>
